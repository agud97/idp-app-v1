# QA Test Environment
# Enable/disable individual applications
apiVersion: idp.example.com/v1alpha1
kind: TestEnvironment
metadata:
  name: qa-env
  namespace: default
spec:
  name: qa

  # Simple Apps
  frontend:
    enabled: false
    replicas: 3
    env:
      - name: API_URL
        value: "http://backend.qa-backend:80"
      - name: ENV
        value: qa
    ingress:
      enabled: true
      host: qa-frontend.example.com

  staticFiles:
    enabled: true

  docs:
    enabled: false

  adminDashboard:
    enabled: false

  landingPage:
    enabled: false

  # Apps with DB
  backend:
    enabled: true
    replicas: 2
    port: 8080
    env:
      - name: ENV
        value: qa
    database:
      version: "15"
      storage: "1Gi"
      dbName: backend_qa
      username: backend
      password: qapass123
    migration:
      enabled: true
      image: postgres:15
      command:
        - /bin/sh
        - -c
        - "until pg_isready -h backend-db -U backend; do sleep 2; done && PGPASSWORD=$POSTGRES_PASSWORD psql -h backend-db -U backend -d backend_qa -c 'CREATE TABLE IF NOT EXISTS users (id SERIAL PRIMARY KEY, name VARCHAR(255), email VARCHAR(255));' && echo 'Migration done'"
    ingress:
      enabled: true
      host: qa-api.example.com

  inventory:
    enabled: false

  orders:
    enabled: false

  billing:
    enabled: false

  analytics:
    enabled: false

  # Multi-service Apps
  platform:
    enabled: true
    services:
      - name: gateway
        image: nginx:alpine
        replicas: 2
        port: 80
        env:
          - name: AUTH_SERVICE
            value: "http://auth:80"
          - name: USER_SERVICE
            value: "http://users:80"
        ingress:
          enabled: true
          host: qa-gateway.example.com

      - name: auth
        image: nginx:alpine
        replicas: 2
        port: 8080
        env:
          - name: JWT_ISSUER
            value: qa-auth

      - name: users
        image: nginx:alpine
        replicas: 2
        port: 8080

      - name: notifications
        image: nginx:alpine
        replicas: 1
        port: 8080

      - name: worker
        image: nginx:alpine
        replicas: 2
        port: 8080
        env:
          - name: QUEUE_URL
            value: "redis://redis:6379"

      - name: redis
        image: redis:7-alpine
        replicas: 1
        port: 6379

  search:
    enabled: false

  messaging:
    enabled: false

  monitoring:
    enabled: false

  cicd:
    enabled: false
