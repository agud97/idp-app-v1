apiVersion: v1
kind: ConfigMap
metadata:
  name: llm-proxy-config
  namespace: llm-proxy
data:
  # Update LAPTOP_TAILSCALE_IP after the laptop connects to Headscale.
  # Run: tailscale ip -4 on the laptop to get the IP (e.g. 100.64.0.2)
  LAPTOP_TAILSCALE_IP: "100.64.0.2"
  nginx.conf: |
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /tmp/nginx.pid;

    events {
        worker_connections 1024;
    }

    http {
        resolver 127.0.0.11 valid=30s;

        server {
            listen 8080;

            location / {
                # LAPTOP_TAILSCALE_IP is substituted via envsubst at startup
                proxy_pass http://${LAPTOP_TAILSCALE_IP}:1234;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_read_timeout 600s;
                proxy_send_timeout 600s;
                proxy_buffering off;
                client_max_body_size 50m;
            }

            location /health {
                access_log off;
                return 200 "ok";
            }
        }
    }
